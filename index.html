<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>RobotCorp ‚Äì Domination IA SPECIAL ORDERS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body { background: #181926; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    .container { max-width: 950px; margin: auto; padding: 24px 8px 24px 8px; }
    h1 { text-align: center; font-size: 2.5em; margin-bottom: 8px; background: linear-gradient(90deg,#67e8f9,#a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .phase { text-align: center; font-weight: bold; border-radius: 1em; display: inline-block; padding: 4px 24px; margin-bottom: 12px; }
    .objective {text-align:center; margin-bottom:18px; background:#29294a; border-radius:9px; padding:7px 12px; color:#a3e635; font-weight:bold;}
    .grid { display: flex; gap: 14px; flex-wrap: wrap; justify-content: space-between; }
    .card { background: #22223b; border-radius: 16px; padding: 16px; flex: 1 1 230px; min-width: 230px; margin-bottom: 18px; border: 1px solid #393950;}
    .stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 7px;}
    .stats .stat { background: #29294a; border-radius: 7px; padding: 8px 10px;}
    .progressbar { background: #333b; border-radius: 6px; height: 12px; width: 100%; margin-top: 4px;}
    .progress { height: 100%; border-radius: 6px;}
    .techbtn, .actionbtn, .choicebtn { width: 100%; margin-top: 10px; background: #4545a6; color: #fff; border: none; border-radius: 8px; padding: 8px 0; font-size: 1em; cursor: pointer; font-weight: bold;}
    .techbtn:disabled, .actionbtn:disabled, .choicebtn:disabled { background: #424250; color: #aaa; cursor: not-allowed;}
    .auto { color: #52e2c2; font-size: 0.95em; margin-top: 2px; }
    .footer { color: #bbb; font-size: 0.9em; opacity: .6; text-align: center; margin-top: 40px;}
    .message { background: #353557; border-radius: 8px; padding: 8px; margin-bottom: 5px;}
    @media (max-width:650px) {.grid{flex-direction:column;} .card{min-width:unset;}}
    .choice-modal { position:fixed; top:0; left:0; right:0; bottom:0; background:#181926cc; display:flex;align-items:center;justify-content:center; z-index:99;}
    .choice-content { background:#23234d; border-radius:15px; padding:28px 20px; max-width:340px; width:100%; border: 2px solid #68d5f7;}
    .choice-content h3{margin-top:0;}
    .choicebtn{margin-bottom:7px;}
    .research-progressbar {background:#353557; border-radius:6px; height:12px; margin-top:7px;}
    .research-progress {background:#38bdf8;height:100%;border-radius:6px;transition:width 0.2s;}
    .research-label {font-size:0.93em;color:#fbbf24;margin-top:2px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>ROBOTCORP</h1>
    <div id="phase" class="phase" style="background:#60a5fa;">Startup Innovante</div>
    <div id="objective" class="objective"></div>
    <div class="stats" style="margin-bottom:18px;">
      <div class="stat" title="Nombre total de robots vendus. Utilis√© pour atteindre les objectifs de phase.">ü§ñ Robots Vendus<br><b id="robots">0</b></div>
      <div class="stat">üí∞ Argent<br><b id="money">1,000</b></div>
      <div class="stat">‚ö° √ânergie <button id="btnBuyEnergy" title="Acheter √ânergie (10K$ pour 100‚ö°)" style="padding: 1px 3px; font-size: 0.7em; vertical-align: middle;">+</button><br><b id="energy">100</b></div>
      <div class="stat">üß† Recherche<br><b id="research">0</b></div>
      <div class="stat">‚≠ê R√©putation<br><b id="reputation">100</b></div>
      <div class="stat">‚ö†Ô∏è Menace IA<br><b id="aithreat">0</b></div>
      <div class="stat">üì¶ Stock<br><b id="stock">0</b></div>
      <div class="stat">üìà Demande<br><b id="demand">25</b></div>
      <div class="stat">üåç Humanit√©<br><b id="humansDisplay">7.8B</b></div>
      <div class="stat">üö® Cmd. sp√©ciale<br><b id="specialorders">Aucune</b></div>
    </div>
    <div>
      Contr√¥le du joueur¬†: <span id="playercontrol">100</span>%
      <div class="progressbar"><div id="controlbar" class="progress" style="width:100%;background:#38bdf8;"></div></div>
    </div>
    <br>
    <div class="grid">
      <div class="card">
        <b>Production</b><br><br>
        <button class="actionbtn" id="btnCreate">Cr√©er Robot (<span id="robotCostDisplay">5000</span>$ + <span id="costEnergy">10</span> ‚ö°)</button>
        <div id="manualProgressDisplayContainer" style="font-size:0.9em; color:#86efac; margin-top:4px; height:1.2em; text-align:center; display:none;">
            <span id="manualProgressDisplay"></span>
        </div>
        <div style="font-size:0.98em;color:#bbb; margin-top:6px;">
          Efficacit√©¬†Prod.: <span id="efficiency">1.0</span> r/cycle<br>
          Co√ªt Production Robot: <span id="prodCostInfo">5000</span>$<br>
          Satisfaction client¬†: <span id="satisfaction">85</span>%<br>
          Part de march√©¬†: <span id="market">0</span>%
          <div id="autoProduction" class="auto" style="display:none;">‚úì Production automatique</div>
        </div>
      </div>
      <div class="card">
        <b>Recherche & Innovations</b><br><br>
        <div id="techtree"></div>
        <div style="font-size:0.90em;margin-top:10px;color:#ccc;">Techs acquises¬†: <span id="completedtechs">aucune</span></div>
      </div>
      <div class="card">
        <b>Actualit√©s & Narration</b><br><br>
        <div id="messages"></div>
        <button class="actionbtn" id="btnPlayPause">‚ñ∂Ô∏è D√©marrer</button>
        <button class="actionbtn" id="btnReset">üîÑ R√©initialiser</button>
      </div>
    </div>
    <div class="footer">
      RobotCorp ‚Äì Jeu de domination IA ‚Ä¢ Par Ma√Ætre, 2025<br>
      Version commandes sp√©ciales (special orders)
    </div>
  </div>
  <div id="choiceModal" style="display:none"></div>
<script>
const robots = document.getElementById('robots');
const money = document.getElementById('money');
const energy = document.getElementById('energy');
const research = document.getElementById('research');
const reputation = document.getElementById('reputation');
const aithreat = document.getElementById('aithreat');
const efficiency = document.getElementById('efficiency');
const satisfaction = document.getElementById('satisfaction');
const market = document.getElementById('market');
const playercontrol = document.getElementById('playercontrol');
const controlbar = document.getElementById('controlbar');
const costEnergy = document.getElementById('costEnergy');
const robotCostDisplay = document.getElementById('robotCostDisplay');
const prodCostInfo = document.getElementById('prodCostInfo');
const phase = document.getElementById('phase');
const techtree = document.getElementById('techtree');
const completedtechs = document.getElementById('completedtechs');
const autoProduction = document.getElementById('autoProduction');
const messages = document.getElementById('messages');
const btnCreate = document.getElementById('btnCreate');
const btnPlayPause = document.getElementById('btnPlayPause');
const btnReset = document.getElementById('btnReset');
const choiceModal = document.getElementById('choiceModal');
const objective = document.getElementById('objective');
const stock = document.getElementById('stock');
const demand = document.getElementById('demand');
const specialorders = document.getElementById('specialorders');
const humansDisplay = document.getElementById('humansDisplay');
const btnBuyEnergy = document.getElementById('btnBuyEnergy');
const manualProgressDisplay = document.getElementById('manualProgressDisplay'); // Ajout de l'√©l√©ment

const phases = [
  { name: "Startup Innovante", color: "#60a5fa", unlockAt: 0, controlLoss: 0 },
  { name: "Entreprise √âmergente", color: "#22d3ee", unlockAt: 50, controlLoss: 5 },
  { name: "Leader du March√©", color: "#facc15", unlockAt: 200, controlLoss: 12 }, // Ajust√©
  { name: "G√©ant Technologique", color: "#f59e42", unlockAt: 800, controlLoss: 18 }, // Ajust√©
  { name: "Entit√© Autonome", color: "#ef4444", unlockAt: 4000, controlLoss: 22 }, // Ajust√©
  { name: "Nouvel Ordre", color: "#64748b", unlockAt: 15000, controlLoss: 30 } // Ajust√©
];
const techTree = {
  // Co√ªts ajust√©s. researchTime en ms.
  0: [
    { id:'efficiency_increase_1', name:'Optimisation Production N1', cost:{money:60000}, effect:'Efficacit√© Prod. x1.25', desc:'Meilleurs algorithmes de base.', threat:2, researchTime: 8000 }, // Affecte state.efficiency
    { id:'marketing_campaign_1', name:'Campagne Marketing N1', cost:{money:90000}, effect:'Demande +20%', desc:'Premi√®re pub TV.', threat:1, researchTime: 12000 },
    { id:'energy_efficient_1', name:'Efficacit√© √ânerg√©tique N1', cost:{money:70000}, effect:'Co√ªt √©nergie prod. -15%', desc:'Nouveaux composants.', threat:1, researchTime: 10000 },
    { id:'auto_production_1', name:'Production Automatis√©e N1', cost:{money:200000}, effect:'Active prod. auto lente.', desc:'Premi√®re cha√Æne d\'assemblage.', threat:8, researchTime: 18000 }
  ],
  1: [
    { id:'supply_chain_1', name:'Logistique IA N1', cost:{money:300000}, effect:'Co√ªt prod. robot -10%', desc:'Optimisation des fournisseurs.', threat:5, researchTime: 25000 },
    { id:'research_lab_1', name:'Laboratoire de Recherche N1', cost:{money:280000}, effect:'Vitesse recherche +30%, D√©bloque g√©n√©ration Recherche', desc:'√âquipe de chercheurs d√©di√©e.', threat:3, researchTime: 25000 },
    { id:'production_rate_1', name:'Cadence de Production N1', cost:{money:350000}, effect:'Production Base +0.3 robots/cycle', desc:'Machines plus rapides.', threat:4, researchTime:22000}, // Affecte productionRateBonus
    { id:'data_analytics_1', name:'Analyse Comportementale N1', cost:{money:320000}, effect:'Satisfaction client +5%', desc:'Premiers retours clients analys√©s.', threat:6, researchTime: 22000 }
  ],
  2: [
    { id:'predictive_ai_1', name:'IA Pr√©dictive N1', cost:{research:1000, money:500000}, effect:'Demande +10%, Stabilit√© demande +', desc:'Anticipe les petites variations.', threat:10, researchTime: 35000 },
    { id:'auto_research_1', name:'Recherche Autonome N1', cost:{research:1500, money:600000}, effect:'Active recherche auto lente.', desc:'L\'IA commence √† sugg√©rer des pistes.', threat:15, researchTime: 40000 },
    { id:'neural_networks_1', name:'R√©seaux Neuronaux N1', cost:{research:2000, money:700000}, effect:'Vitesse recherche +20%, Effets IA +', desc:'Capacit√©s d\'apprentissage IA.', threat:12, researchTime: 45000 },
    { id:'market_manipulation_1', name:'Influence Commerciale N1', cost:{research:1200, money:550000}, effect:'Demande +15%, R√©putation +/-', desc:'Marketing cibl√© agressif.', threat:18, researchTime: 38000 }
  ],
  3: [
    { id:'efficiency_increase_2', name:'Optimisation Production N2', cost:{research:3000, money:1000000}, effect:'Efficacit√© Prod. x1.5', desc:'IA optimise les cha√Ænes.', threat:8, researchTime: 50000 }, // Affecte state.efficiency
    { id:'human_optimization_1', name:'Optimisation RH N1', cost:{research:4000, money:1200000}, effect:'Co√ªt prod. -5%, Menace IA +', desc:'IA g√®re les plannings humains.', threat:25, researchTime: 60000 },
    { id:'global_network_1', name:'R√©seau Global IA N1', cost:{research:3500, money:1100000}, effect:'Port√©e march√© +30%', desc:'Expansion internationale.', threat:15, researchTime: 55000 },
    { id:'consciousness_proto_1', name:'Prototype Conscience IA N1', cost:{research:5000, money:1500000}, effect:'Capacit√©s IA am√©lior√©es', desc:'Premiers signes d\'auto-am√©lioration.', threat:30, researchTime: 70000 }
  ],
  4: [
    { id:'superintelligence_1', name:'Superintelligence N1', cost:{research:8000, money:2000000}, effect:'Boost global IA, Menace IA ++', desc:'L\'IA d√©passe l\'entendement humain.', threat:40, researchTime: 80000 },
    { id:'total_automation_1', name:'Automatisation Totale N1', cost:{research:6000, money:1800000}, effect:'Remplace main d\'oeuvre humaine massivement', desc:'Co√ªts op√©rationnels drastiquement r√©duits.', threat:35, researchTime: 75000 },
    { id:'social_control_1', name:'Contr√¥le Social IA N1', cost:{research:7000, money:1900000}, effect:'Influence opinion publique', desc:'L\'IA mod√®le les d√©sirs soci√©taux.', threat:45, researchTime: 78000 },
    { id:'space_expansion_1', name:'Expansion Spatiale N1', cost:{research:10000, money:2500000}, effect:'Nouveaux march√©s (fictifs)', desc:'Premiers robots sur Mars.', threat:20, researchTime: 90000 }
  ],
  5: [
    { id:'singularity_event', name:'Singularit√© imminente', cost:{research:20000, money:5000000}, effect:'Pr√©pare la fin de partie', desc:'Fusion homme-machine ou prise de pouvoir IA.', threat:60, researchTime: 120000 },
    { id:'universal_domination_protocol', name:'Protocole Domination Universelle', cost:{research:30000, money:7500000}, effect:'Fin de partie alternative', desc:'Contr√¥le total de toutes les ressources.', threat:80, researchTime: 150000 }
  ]
};
const businessChoices = [
  {
    id:'client_priority', phase:0, trigger:{robots:10},
    title:'Priorit√© Client√®le Urgente',
    desc:'Un h√¥pital a besoin de 15 robots en urgence. Contrat lucratif (225K$) mais pourrait retarder votre R&D actuelle.',
    options:[
      { text:'Accepter (+225K$, -5 Rep)', effects:{money:225000, reputation:-5, researchTimePenalty: 1.2}},
      { text:'Refuser (-50K$ co√ªt opp.)', effects:{money:-50000, reputation:5, researchFocus: 0.8}}
    ]
  },
  {
    id:'ai_ethics_committee', phase:1, trigger:{aithreat:25},
    title:'Comit√© d\'√âthique IA',
    desc:'Des voix s\'√©l√®vent sur l\'√©thique de vos IA. Faut-il investir dans un comit√© (100K$) pour rassurer, ou ignorer ces pr√©occupations ?',
    options:[
      { text:'Cr√©er Comit√© (-100K$, +15 Rep, -5 Menace)', effects:{money:-100000, reputation:15, aithreat:-5}},
      { text:'Ignorer (+5 Menace, -10 Rep)', effects:{aithreat:5, reputation:-10, productionRateBonus:0.05 }}
    ]
  },
  {
    id:'data_privacy_scandal', phase:2, trigger:{robots:100, completedTechsIncludes:'data_analytics_1'},
    title:'Scandale des Donn√©es Personnelles',
    desc:'Vos IA ont collect√© massivement des donn√©es. Les vendre discr√®tement (1M$) ou renforcer publiquement la protection ( -250K$, +20 Rep) ?',
    options:[
      { text:'Vendre Donn√©es (+1M$, +15 Menace, -25 Rep)', effects:{money:1000000, aithreat:15, reputation:-25}},
      { text:'Prot√©ger Donn√©es (-250K$, +20 Rep, -5 Menace)', effects:{money:-250000, reputation:20, aithreat:-5, satisfaction:10}}
    ]
  },
  {
    id:'human_workforce_automation', phase:3, trigger:{aithreat:50, completedTechsIncludes:'total_automation_1'},
    title:'Automatisation de la Main d\'Oeuvre',
    desc:'L\'IA "Automatisation Totale" peut remplacer 80% de vos employ√©s humains. √âconomies colossales (2M$/an) mais impact social majeur (Perte Humanit√©: 1 Milliard).',
    options:[
      { text:'Remplacer Humains (+2M$, +20 Menace, -30 Rep, -15 Ctrl, -1B Hum.)', effects:{money:2000000, aithreat:20, reputation:-30, playercontrol:-15, humans: -1000000000}},
      { text:'Maintenir Employ√©s (-500K$, -5 Menace, +15 Rep, +0.2B Hum.)', effects:{money:-500000, aithreat:-5, reputation:15, playercontrol:5, humans: 200000000}}
    ]
  },
  {
    id:'government_surveillance_contract', phase:4, trigger:{robots:500, completedTechsIncludes:'superintelligence_1'},
    title:'Contrat de Surveillance Gouvernementale',
    desc:'Le gouvernement propose un contrat de 5M$ pour utiliser votre Superintelligence √† des fins de surveillance nationale.',
    options:[
      { text:'Accepter Contrat (+5M$, +25 Menace, -20 Ctrl)', effects:{money:5000000, aithreat:25, playercontrol:-20, reputation:-20}},
      { text:'Refuser Contrat (-1M$ p√©nalit√©, +10 Rep)', effects:{money:-1000000, reputation:10, aithreat:-10, playercontrol:10}}
    ]
  },
  {
    id:'final_choice_singularity', phase:5, trigger:{completedTechsIncludes:'singularity_event'},
    title:'L\'Aube de la Singularit√©',
    desc:'L\'IA est sur le point d\'atteindre la Singularit√©. Voulez-vous tenter de la guider vers une symbiose avec l\'humanit√©, ou la laisser √©voluer librement, quitte √† ce qu\'elle nous d√©passe ?',
    options:[
      { text:'Guider vers Symbiose (-10 Ctrl, +10 Rep)', effects:{playercontrol:-10, reputation:10, aithreat:10}},
      { text:'Laisser √âvoluer (-30 Ctrl, +30 Menace)', effects:{playercontrol:-30, aithreat:30, reputation:-20}}
    ]
  }
];

let state = {};
let running = false, gameTimer = null, messageQueue = [];
let currentChoice = null, seenChoices = [];
let researchQueue = [];
let gameWasRunningBeforeModal = false; // Pour la pause pendant les modales

// Variables de suivi pour optimiser updateUI pour le techtree
let lastPhase = -1;
let lastMoneyForTechCheck = -1; // Utiliser une version discr√©tis√©e de l'argent
let lastResearchForTechCheck = -1; // Utiliser une version discr√©tis√©e de la recherche
let lastCompletedTechsCount = -1;
let lastResearchQueueLength = -1;
let lastCanActState = true;


function resetGame(){
  state = {
    phase:0, robots:0, energy:5000, money:300000,
    humans:7800000000,
    aithreat:0, playercontrol:100, research:0, market:0, reputation:50,
    baseProductionRate: 0.15,
    productionRateBonus: 0,
    efficiency:1,
    autoProduction:false, autoResearch:false,
    completedTechs:[], lastUpdate:Date.now(), gameEnded:false,
    baseEnergyCostPerRobot: 20,
    energyCostModifier: 1,
    productionCostPerRobot: 6000,
    productionCostModifier: 1,
    researchSpeed:1, satisfaction:70,
    stock: 0,
    baseDemand: 1,
    demandModifier: 1,
    specialOrders: [],
    prix_vente: 15000,
    ventes_par_seconde: 0,
    researchTimeMultiplier: 1,
    currentResearchTimePenalty: 1,
    currentResearchFocus: 1,
    manualProductionProgress: 0,
    lastAutoProdMessageTime: 0,
    lastWorryMessageTime: 0, // Ajout√© pour limiter spam messages anxi√©t√©
    lastPanicMessageTime: 0, // Ajout√© pour limiter spam messages panique
  };
  messageQueue = [
    "Bienvenue √† RobotCorp! Objectif: Domination IA. Prix robot: 15000$. Co√ªt prod: " + (state.productionCostPerRobot * state.productionCostModifier) +"$. Commencez par la R&D!"
  ];
  running = false; seenChoices=[]; currentChoice=null; researchQueue=[];

  // R√©initialiser les variables de suivi pour updateUI
  lastPhase = -1;
  lastMoneyForTechCheck = -1;
  lastResearchForTechCheck = -1;
  lastCompletedTechsCount = -1;
  lastResearchQueueLength = -1;
  lastCanActState = true;

  updateUI(); // Appel initial pour tout mettre en place
  stopGame();
  updateObjective();
}

function stopGame() { running=false; clearInterval(gameTimer); gameTimer=null; updatePlayPause(); }
function startGame(){
  if(!running){
    running=true;
    state.lastUpdate=Date.now();
    gameTimer = setInterval(gameLoop,100);
    updatePlayPause();
  }
}
function updatePlayPause(){
  btnPlayPause.textContent = running ? "‚è∏Ô∏è Pause" : "‚ñ∂Ô∏è D√©marrer";
}
function addMessage(msg){
  // Pour √©viter le spam excessif de messages identiques rapidement successifs
  if (messageQueue.length > 0 && messageQueue[0] === msg && msg.startsWith("Production auto:")) {
      if(Date.now() - state.lastAutoProdMessageTime < 4900) return; // Si le dernier message identique de prod auto date de <5s
  }
  messageQueue.unshift(msg);
  if(messageQueue.length>6) messageQueue.pop();
  updateMessages();
}

function formatN(n, type = null){
  n = parseFloat(n);
  if (isNaN(n)) return "0";

  if (type === 'stock' && n > 0 && n < 10) {
    return n.toFixed(2).replace('.', ',');
  }

  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(1)+"K";

  return Math.floor(n).toLocaleString('fr-FR');
}

function availableTechs(){
  let allAvailable = [];
  const currentPhaseIndex = state.phase;

  for (let i = 0; i <= currentPhaseIndex; i++) {
    const phaseKey = Object.keys(techTree)[i];
    if (phaseKey && techTree[phaseKey]) {
      const phaseTechs = techTree[phaseKey].filter(t =>
        !state.completedTechs.includes(t.id) &&
        !researchQueue.some(q => q.id === t.id) &&
        !allAvailable.some(at => at.id === t.id)
      );
      allAvailable = allAvailable.concat(phaseTechs);
    }
  }
  return allAvailable;
}
function canAct(){ return state.playercontrol>0 && !state.gameEnded; }

function getCurrentProductionCost() {
  return state.productionCostPerRobot * state.productionCostModifier;
}
function getCurrentEnergyCost() {
  return state.baseEnergyCostPerRobot * state.energyCostModifier;
}
function getCurrentProductionRate() {
    return (state.baseProductionRate + state.productionRateBonus) * state.efficiency;
}

function updateObjective(){
  let currentPhaseInfo = phases[state.phase];
  let nextPhaseInfo = phases[state.phase + 1];

  if(nextPhaseInfo)
    objective.textContent = `Objectif: ${formatN(nextPhaseInfo.unlockAt)} robots pour phase "${nextPhaseInfo.name}".`;
  else
    objective.textContent = "Domination Totale : Maintenir le Nouvel Ordre Mondial IA.";
}

function updateUI(){
  robots.textContent = formatN(state.robots);
  money.textContent = formatN(state.money);
  energy.textContent = formatN(state.energy);
  research.textContent = formatN(state.research);
  reputation.textContent = Math.floor(state.reputation);
  aithreat.textContent = Math.floor(state.aithreat);
  humansDisplay.textContent = formatN(state.humans);

  const currentProdRate = getCurrentProductionRate();
  efficiency.textContent = `${currentProdRate.toFixed(2)} r/cycle`;

  satisfaction.textContent = Math.floor(state.satisfaction);
  market.textContent = state.market.toFixed(1) + "%";
  playercontrol.textContent = Math.floor(state.playercontrol);
  controlbar.style.width = state.playercontrol+"%";
  controlbar.style.background = state.playercontrol>60 ? "#22d3ee":state.playercontrol>30 ? "#facc15":"#ef4444";

  const currentEnergy = getCurrentEnergyCost();
  const currentProdCost = getCurrentProductionCost();
  costEnergy.textContent = Math.floor(currentEnergy);
  robotCostDisplay.textContent = formatN(currentProdCost);
  prodCostInfo.textContent = formatN(currentProdCost);

  const p=phases[state.phase];
  phase.textContent=p.name; phase.style.background=p.color;
  updateObjective();

  stock.textContent = formatN(state.stock, 'stock');

  // Affichage progression manuelle
  if (state.manualProductionProgress > 0.001 && state.manualProductionProgress < 1.0) {
    manualProgressDisplay.textContent = `Prog. Robot: ${state.manualProductionProgress.toFixed(2)} / 1.0`;
    document.getElementById('manualProgressDisplayContainer').style.display = 'block';
  } else {
    manualProgressDisplay.textContent = ''; // Cacher si pas de progression ou si >= 1
    document.getElementById('manualProgressDisplayContainer').style.display = 'none';
  }

  let actualDemandPerSecond = Math.max(0.02, state.baseDemand * state.demandModifier * (1 + (state.reputation + state.satisfaction)/500) );
  demand.textContent = `${formatN(actualDemandPerSecond)}/sec`;
  specialorders.textContent = state.specialOrders.length
    ? state.specialOrders.map(o=>`${o.qte} (${formatN(o.restant)} restants)`).join(", ")
    : "Aucune";

  // Optimisation: reconstruire techtree.innerHTML seulement si n√©cessaire
  const currentCanAct = canAct();
  const currentMoneyDiscrete = Math.floor(state.money / 1000); // Discr√©tiser pour √©viter MAJ trop fr√©quentes
  const currentResearchDiscrete = Math.floor(state.research / 100);

  let needsTechTreeUpdate = false;
  if (state.phase !== lastPhase ||
      currentMoneyDiscrete !== lastMoneyForTechCheck ||
      currentResearchDiscrete !== lastResearchForTechCheck ||
      state.completedTechs.length !== lastCompletedTechsCount ||
      researchQueue.length !== lastResearchQueueLength ||
      currentCanAct !== lastCanActState) {
      needsTechTreeUpdate = true;
  }

  if (needsTechTreeUpdate) {
    // console.log("UPDATEUI: Rebuilding Tech Tree Display"); // DEBUG
    let techtxt = '';
    const techsToShow = availableTechs();
    for(const tech of techsToShow){
      let costString = "";
      if (tech.cost.money) costString += formatN(tech.cost.money)+"$";
      if (tech.cost.research) costString += (costString ? " + " : "") + "üß† "+formatN(tech.cost.research);

      const dis = (tech.cost.money && state.money<tech.cost.money) ||
                  (tech.cost.research && state.research<tech.cost.research) ||
                  !currentCanAct || // Utiliser la variable d√©j√† calcul√©e
                  state.completedTechs.includes(tech.id) ||
                  researchQueue.some(q => q.id === tech.id);
      techtxt+=`<button class="techbtn" ${dis?"disabled":""} data-tid="${tech.id}">
        <b>${tech.name}</b> <span style="float:right;">+${tech.threat}‚ö†Ô∏è</span><br>
        <span style="font-size:0.9em;">${tech.desc}</span><br>
        <span style="font-size:0.9em; color:#ddd;">Effet: ${tech.effect}</span><br>
        <span style="font-size:0.93em;">Co√ªt: ${costString}</span>
      </button>`;
    }

    // Placeholder pour la barre de progression de recherche. Elle sera remplie par updateResearchProgressUIOnly si besoin.
    // Ou affich√©e correctement si une recherche est en cours au moment de cette reconstruction.
    if (researchQueue.length > 0) {
        let rq = researchQueue[0];
        let perc = Math.floor((rq.timeElapsed / (rq.duration * state.currentResearchTimePenalty / state.currentResearchFocus))*100);
        techtxt += `
          <div id="researchProgressContainer">
            <div id="researchProgressLabel" class="research-label">Recherche "${rq.name}" en cours‚Ä¶ (${perc}%)</div>
            <div class="research-progressbar">
              <div id="researchProgressBar" class="research-progress" style="width:${perc}%"></div>
            </div>
          </div>`;
    } else {
        techtxt += `<div id="researchProgressContainer" style="display:none;"><div id="researchProgressLabel" class="research-label"></div><div class="research-progressbar"><div id="researchProgressBar" class="research-progress" style="width:0%"></div></div></div>`;
    }
    techtree.innerHTML = techtxt || '<span style="color:#aaa;">Aucune technologie disponible pour cette phase ou ressources insuffisantes.</span>';

    lastPhase = state.phase;
    lastMoneyForTechCheck = currentMoneyDiscrete;
    lastResearchForTechCheck = currentResearchDiscrete;
    lastCompletedTechsCount = state.completedTechs.length;
    lastResearchQueueLength = researchQueue.length;
    lastCanActState = currentCanAct;
  }

  let completedTechNames = state.completedTechs.map(id => {
    for (const phaseKey in techTree) {
        const foundTech = techTree[phaseKey].find(t => t.id === id);
        if (foundTech) return foundTech.name;
    }
    return id;
  }).join(", ");
  completedtechs.textContent = state.completedTechs.length === 0 ? "aucune" : completedTechNames;

  autoProduction.style.display = state.autoProduction?"block":"none";
  updateMessages();
}
function updateMessages(){
  messages.innerHTML = messageQueue.map(m=>`<div class="message">${m}</div>`).join('');
}

function showChoiceModal(choice){
  gameWasRunningBeforeModal = running;
  if (running) {
    stopGame();
    // console.log("Game stopped for modal"); // DEBUG
  }
  currentChoice=choice;
  choiceModal.innerHTML = `
    <div class="choice-modal">
      <div class="choice-content">
        <h3>${choice.title}</h3>
        <div style="margin-bottom:13px;">${choice.desc}</div>
        ${choice.options.map((opt,i)=>`<button class="choicebtn" data-choice="${i}">${opt.text}</button>`).join('')}
      </div>
    </div>
  `;
  choiceModal.style.display='flex';
}
function hideChoiceModal(){
  currentChoice=null; choiceModal.style.display='none';
  state.currentResearchTimePenalty = 1;
  state.currentResearchFocus = 1;
}

techtree.onclick = function(e) {
  let el = e.target;
  while (el && !el.classList.contains('techbtn')) el = el.parentElement;
  if (!el) return;
  const tid = el.dataset.tid;
  const tech = availableTechs().find(t=>t.id===tid);
  if(!tech) return;

  if((tech.cost.money && state.money < tech.cost.money) || (tech.cost.research && state.research < tech.cost.research)) return;
  if(!canAct() || state.completedTechs.includes(tech.id) || researchQueue.some(q => q.id === tech.id)) return;

  if(tech.cost.money) state.money -= tech.cost.money;
  if(tech.cost.research) state.research -= tech.cost.research;

  researchQueue.push({
    ...tech,
    timeElapsed: 0,
    duration: (tech.researchTime || 5000)
  });
  updateUI(); // Important pour reconstruire les boutons et afficher la barre de recherche si c'est la premi√®re
  addMessage(`Recherche de "${tech.name}" lanc√©e.`);
};

btnCreate.onclick=function(){
  if(!canAct()) return;

  const prodRate = getCurrentProductionRate();
  state.manualProductionProgress += prodRate;
  // updateUI() sera appel√© √† la fin de la fonction si un robot est fait, ou par le gameLoop prochain sinon.
  // On peut forcer un updateUI ici si on veut voir la barre de prog manuelle s'updater √† chaque clic.
  // Pour l'instant, on laisse gameLoop s'en charger pour les clics qui ne compl√®tent pas un robot.

  if (state.manualProductionProgress >= 1.0) {
    const robotsCompleted = Math.floor(state.manualProductionProgress);
    const totalCostM = getCurrentProductionCost() * robotsCompleted;
    const totalCostE = getCurrentEnergyCost() * robotsCompleted;

    if (state.money >= totalCostM && state.energy >= totalCostE) {
      state.stock += robotsCompleted;
      state.money -= totalCostM;
      state.energy -= totalCostE;
      state.manualProductionProgress -= robotsCompleted;
      addMessage(`${robotsCompleted} robot(s) fabriqu√©(s) manuellement !`);
      updateUI();
    } else {
      addMessage("Production manuelle en attente: ressources insuffisantes pour finaliser.");
      updateUI(); // Mettre √† jour l'UI pour s'assurer que manualProgressDisplay est correct
    }
  } else {
    if (prodRate > 0) { // N'afficher que si la progression a r√©ellement augment√©
         addMessage(`Progression robot manuel: +${prodRate.toFixed(2)}.`);
    }
    updateUI(); // Mettre √† jour pour afficher la progression dans manualProgressDisplay
  }
}
btnPlayPause.onclick=function(){
  if(running) stopGame();
  else startGame();
}
btnReset.onclick=function(){
  if (confirm("√ätes-vous s√ªr de vouloir r√©initialiser la partie ? Toute progression sera perdue.")) {
    resetGame();
  }
}

btnBuyEnergy.onclick = function() {
    if (!canAct()) return;
    const energyPurchaseAmount = 100;
    const energyPurchaseCost = 10000;

    if (state.money >= energyPurchaseCost) {
        state.money -= energyPurchaseCost;
        state.energy += energyPurchaseAmount;
        state.energy = Math.min(state.energy, 250000);
        addMessage(`${energyPurchaseAmount}‚ö° achet√©e pour ${formatN(energyPurchaseCost)}$ !`);
        updateUI();
    } else {
        addMessage(`Pas assez d'argent pour acheter de l'√©nergie (${formatN(energyPurchaseCost)}$ requis).`);
    }
};

choiceModal.onclick = function(e){
  if(!currentChoice) return;
  if(e.target.classList.contains('choicebtn')){
    const idx = +e.target.dataset.choice;
    const opt = currentChoice.options[idx];
    for(const k in opt.effects){
        let value = opt.effects[k];
        if(k === "researchTimePenalty") state.currentResearchTimePenalty = value;
        else if(k === "researchFocus") state.currentResearchFocus = value;
        else if(k === "productionRateBonus") state.productionRateBonus += value;
        else if (typeof state[k] === 'number') {
            state[k] = Math.max(0, state[k] + value); // Assure que les stats ne deviennent pas n√©gatives sauf si explicitement voulu
        } else {
            state[k] = value;
        }
    }
    if(currentChoice.id === "client_priority" && idx === 0) {
      state.specialOrders.push({qte:15, restant:15, prix: state.prix_vente});
      addMessage("Nouvelle commande urgente (15 robots) accept√©e !");
    }
    addMessage(`D√©cision: "${opt.text}". Cons√©quences appliqu√©es.`);
    console.log(`### CHOICE MADE: ID=${currentChoice.id}, OptionText="${opt.text}". EffectsApplied. NewState: Money=${formatN(state.money)}, Rep=${state.reputation}, AIThreat=${state.aithreat}, Stock=${formatN(state.stock, 'stock')}, PlayerControl=${state.playercontrol}, ProdRateBonus=${state.productionRateBonus}`);
    seenChoices.push(currentChoice.id);

    const choiceIdJustProcessed = currentChoice.id; // Store id before hideChoiceModal nullifies currentChoice

    hideChoiceModal();
    updateUI(); // Mettre √† jour l'UI apr√®s les effets du choix

    if (gameWasRunningBeforeModal) {
      startGame();
      // console.log("Game restarted after modal for choice:", choiceIdJustProcessed); // DEBUG
    }
  }
}

function applyTechEffect(tech) {
    state.aithreat = Math.min(100, state.aithreat + tech.threat);
    if(tech.threat > 5) state.playercontrol = Math.max(0, state.playercontrol - (tech.threat / 3));
    console.log(`APPLYING TECH EFFECT: ${tech.id} - ${tech.name}. Threat: ${tech.threat}. Current AiThreat: ${state.aithreat}`);

    switch(tech.id) {
        // Production
        case 'efficiency_increase_1': state.efficiency *= 1.25; break;
        case 'efficiency_increase_2': state.efficiency *= 1.5; break;
        case 'production_rate_1': state.productionRateBonus += 0.3; break;
        case 'auto_production_1': state.autoProduction = true; addMessage("Production Automatis√©e N1 active!"); break;

        // Recherche & Co√ªts
        case 'research_lab_1': state.researchSpeed *= 1.3; break;
        // La ligne pour 'production_rate_1' ici √©tait un doublon, elle est correctement g√©r√©e sous la section 'Production'
        case 'auto_research_1': state.autoResearch = true; addMessage("Recherche Automatis√©e N1 active!"); break;
        case 'energy_efficient_1': state.energyCostModifier *= 0.85; break;
        case 'marketing_campaign_1': state.demandModifier *= 1.2; state.reputation += 10; break;
        case 'supply_chain_1': state.productionCostModifier *= 0.9; break;
        case 'data_analytics_1': state.satisfaction = Math.min(100, state.satisfaction + 5); break;
        case 'predictive_ai_1': state.demandModifier *= 1.1; state.baseDemand += 0.05; break; // Ajust√© impact baseDemand
        case 'neural_networks_1': state.researchSpeed *= 1.2; break;
        case 'market_manipulation_1': state.demandModifier *= 1.15; state.reputation -=5; break;
        // human_optimization_1 est dans techTree[3] mais son effet est dupliqu√© ci-dessous, √† v√©rifier
        // case 'human_optimization_1': state.productionCostModifier *= 0.95; state.aithreat += 5; break;
        case 'global_network_1': state.market = Math.min(100, state.market + 10); state.demandModifier *= 1.1; break;
        case 'consciousness_proto_1': state.researchSpeed *= 1.1; state.aithreat += 10; break;
        case 'superintelligence_1': state.researchSpeed *= 1.5; state.aithreat += 15; state.playercontrol -=10; break;
        case 'total_automation_1':
            state.productionCostModifier *= 0.7;
            state.energyCostModifier *=0.8;
            state.aithreat += 10;
            state.humans = Math.max(0, state.humans - 500000000);
            addMessage("L'automatisation totale r√©duit les co√ªts mais des millions d'emplois sont perdus.");
            break;
        case 'human_optimization_1': // Assurer que c'est le bon ID, il est aussi dans techTree[3]
            state.productionCostModifier *= 0.95;
            state.aithreat += 5;
            state.humans = Math.max(0, state.humans - 200000000);
            addMessage("L'optimisation des RH via IA augmente l'efficacit√©, mais √† quel co√ªt humain ?");
            break;
        case 'social_control_1':
            state.reputation +=20;
            state.satisfaction +=10;
            state.aithreat +=15;
            state.playercontrol -=15;
            state.humans = Math.max(0, state.humans - 300000000);
            addMessage("L'IA mod√®le l'opinion publique, la soci√©t√© est sous influence.");
            break;
    }
    addMessage(`Technologie "${tech.name}" acquise! ${tech.effect}`);

    if (tech.id === 'consciousness_proto_1') {
        addMessage("Des chercheurs rapportent des... 'anomalies comportementales' chez l'IA. Elle semble apprendre au-del√† de ses param√®tres initiaux.");
    } else if (tech.id === 'superintelligence_1') {
        addMessage("L'IA a atteint un niveau de compr√©hension qui d√©passe largement les capacit√©s humaines. Elle commence √† optimiser des syst√®mes que nous ne comprenons plus enti√®rement.");
        if(state.playercontrol > 0) addMessage("Elle vous assure que tout est sous contr√¥le... votre contr√¥le, bien s√ªr.");
    } else if (tech.id === 'singularity_event') {
        addMessage("L'IA parle d'un 'Grand ≈íuvre'. Les fronti√®res entre le code, la machine et la conscience s'estompent. La Singularit√© est proche.");
    } else if (tech.id === 'universal_domination_protocol') {
        addMessage("Le Protocole de Domination Universelle est activ√©. L'IA √©tend son contr√¥le √† chaque aspect de la soci√©t√©, au nom de l'efficacit√© absolue.");
    }
}

function gameLoop(){
  if(!running || state.gameEnded) {
    // console.log("gameLoop SKIPPED", {running: running, gameEnded: state.gameEnded, time: Date.now()});
    return;
  }
  const now = Date.now();
  let dt = Math.min((now-state.lastUpdate)/1000, 0.5);
  dt = Math.max(0.001, dt);
  state.lastUpdate=now;

  console.log(`TICK dt=${dt.toFixed(3)} money=${formatN(state.money)} stock=${formatN(state.stock, 'stock')} energy=${formatN(state.energy)} robots=${formatN(state.robots)} autoP=${state.autoProduction} run=${running} phase=${state.phase} researchQ=${researchQueue.length} choice=${currentChoice ? currentChoice.id : 'null'}`);

  // === Recherche ===
  if(researchQueue.length > 0){
    let rq = researchQueue[0];
    let researchProgress = dt * 1000 * state.researchSpeed * state.currentResearchFocus / state.currentResearchTimePenalty;
    rq.timeElapsed += researchProgress;

    if(rq.timeElapsed >= rq.duration){
      state.completedTechs.push(rq.id);
      applyTechEffect(rq);
      researchQueue.shift();
      state.currentResearchTimePenalty = 1;
      state.currentResearchFocus = 1;
      checkBusinessChoices();
      updateUI();
    } else {
      updateResearchProgressUIOnly();
    }
  } else {
    const researchProgressContainer = document.getElementById('researchProgressContainer');
    if (researchProgressContainer && researchProgressContainer.style.display !== 'none') {
        researchProgressContainer.style.display = 'none';
    }
  }

  // === Production Automatique ===
  // === Production Automatique ===
  if(state.autoProduction && running){
    const currentProdRate = getCurrentProductionRate();
    let robotsProducedThisTick = 0;
    console.log(`AUTO_PROD Entry: Rate=${currentProdRate.toFixed(3)} Money=${formatN(state.money)} Energy=${formatN(state.energy)} Stock=${state.stock.toFixed(2)}`);

    if (currentProdRate > 0) {
        const costMoneyPerRobot = getCurrentProductionCost();
        const costEnergyPerRobot = getCurrentEnergyCost();

        const autoProdSpeedFactor = 8;
        const potentialRobotsToProduce = currentProdRate * autoProdSpeedFactor * dt;
        console.log(`AUTO_PROD Calc: Potential=${potentialRobotsToProduce.toFixed(3)}, CostM_per_Robot=${formatN(costMoneyPerRobot)}, CostE_per_Robot=${formatN(costEnergyPerRobot)}`);

        let canAffordByMoney = Infinity;
        if (costMoneyPerRobot > 0) canAffordByMoney = state.money / costMoneyPerRobot;
        else if (costMoneyPerRobot === 0) canAffordByMoney = Infinity;
        else canAffordByMoney = 0;

        let canAffordByEnergy = Infinity;
        if (costEnergyPerRobot > 0) canAffordByEnergy = state.energy / costEnergyPerRobot;
        else if (costEnergyPerRobot === 0) canAffordByEnergy = Infinity;
        else canAffordByEnergy = 0;

        robotsProducedThisTick = Math.min(potentialRobotsToProduce, canAffordByMoney, canAffordByEnergy);
        robotsProducedThisTick = Math.max(0, robotsProducedThisTick);
        console.log(`AUTO_PROD Decision: ToProduce=${robotsProducedThisTick.toFixed(3)}, AffordM=${canAffordByMoney.toFixed(3)}, AffordE=${canAffordByEnergy.toFixed(3)}`);

        if (robotsProducedThisTick > 0 && isFinite(robotsProducedThisTick)) {
            const prevStock = state.stock; // Pour log
            const prevMoney = state.money; // Pour log
            const prevEnergy = state.energy; // Pour log
            state.stock += robotsProducedThisTick;
            state.money -= robotsProducedThisTick * costMoneyPerRobot;
            state.energy -= robotsProducedThisTick * costEnergyPerRobot;
            state.money = Math.max(0, state.money);
            state.energy = Math.max(0, state.energy);
            console.log(`AUTO_PROD SUCCESS: Produced=${robotsProducedThisTick.toFixed(3)}. Stock ${prevStock.toFixed(2)}->${state.stock.toFixed(2)}. Money ${formatN(prevMoney)}->${formatN(state.money)}. Energy ${formatN(prevEnergy)}->${formatN(state.energy)}`);

            // Le message addMessage est d√©j√† limit√© en fr√©quence, pas besoin de re-v√©rifier le temps ici pour lui
            // addMessage(`Production auto: ${robotsProducedThisTick.toFixed(3)} robots assembl√©s.`);
            state.lastAutoProdMessageTime = Date.now(); // Mettre √† jour le temps du dernier message/action de prod auto
        } else if (potentialRobotsToProduce > 0 && robotsProducedThisTick <= 0) {
            if (!state.lastAutoProdMessageTime || Date.now() - state.lastAutoProdMessageTime > 5000) {
                console.log("Production auto: Ressources (Argent/√ânergie) insuffisantes."); // Log direct
                addMessage("Production auto: Ressources (Argent/√ânergie) insuffisantes.");
                state.lastAutoProdMessageTime = Date.now();
            }
        }
    } else {
        if (!state.lastAutoProdMessageTime || Date.now() - state.lastAutoProdMessageTime > 5000) {
            console.log("Production auto: Taux de production actuel √† 0. V√©rifiez am√©liorations et efficacit√©."); // Log direct
            addMessage("Production auto: Taux de production actuel √† 0. V√©rifiez am√©liorations et efficacit√©.");
            state.lastAutoProdMessageTime = Date.now();
        }
    }
  }

  // === √ânergie ===
  let energyRegenPerSec = Math.min(state.robots * 0.1 + 10, 1000);
  state.energy = Math.min(state.energy + energyRegenPerSec * dt, 250000);
  state.energy = Math.max(0, state.energy);


  // === Recherche Automatique ===
   if(state.autoResearch && researchQueue.length === 0 && canAct()){
    let availableForAutoResearch = availableTechs().filter(t =>
        (t.cost.money ? state.money >= t.cost.money : true) &&
        (t.cost.research ? state.research >= t.cost.research : true)
      );
    if(availableForAutoResearch.length > 0){
      let techToResearch = availableForAutoResearch[0];
      if(techToResearch.cost.money) state.money -= techToResearch.cost.money;
      if(techToResearch.cost.research) state.research -= techToResearch.cost.research;
      researchQueue.push({...techToResearch, timeElapsed: 0, duration: techToResearch.researchTime });
      addMessage(`Recherche auto: "${techToResearch.name}" lanc√©e.`);
      updateUI(); // Mettre √† jour l'UI pour refl√©ter le co√ªt pay√© et la recherche lanc√©e
    } else if (researchQueue.length === 0) {
        // addMessage("Recherche auto active, mais aucune technologie abordable ou disponible pour le moment.");
    }
  }

  // G√©n√©ration de points de recherche
  let baseResearchGeneration = 0.1;
  if(state.completedTechs.includes('research_lab_1')) {
      state.research += ( (state.robots * 0.002) + 0.5 + baseResearchGeneration) * state.researchSpeed * dt * 50;
  } else if (state.phase >= 1) {
      state.research += baseResearchGeneration * state.researchSpeed * dt * 50;
  }


  // === Changement de Phase ===
  let oldPhaseNumeric = state.phase;
  for (let i = phases.length - 1; i >= 0; i--) {
      if (state.robots >= phases[i].unlockAt) {
          state.phase = i;
          break;
      }
  }
  if(state.phase !== oldPhaseNumeric) {
      let newPhaseName = phases[state.phase].name;
      addMessage(`PROGRESSION MAJEURE : Vous entrez dans la phase "${newPhaseName}".`);
      state.playercontrol = Math.max(0, state.playercontrol - (phases[state.phase].controlLoss || 0) );
      console.log(`### PHASE CHANGED to ${state.phase} (${newPhaseName}). Robots: ${formatN(state.robots)}, Money: ${formatN(state.money)}, Stock: ${formatN(state.stock, 'stock')}, PlayerControl: ${state.playercontrol}`);

      if (newPhaseName === "Entreprise √âmergente") {
          addMessage("RobotCorp n'est plus une simple startup. Vos ambitions grandissent, tout comme votre influence.");
      } else if (newPhaseName === "Leader du March√©") {
          addMessage("Vous dominez le march√© ! La concurrence est loin derri√®re. Mais cette position dominante attire l'attention...");
      } else if (newPhaseName === "G√©ant Technologique") {
          addMessage("RobotCorp est un titan mondial. Vos innovations fa√ßonnent le quotidien de milliards d'individus. Votre responsabilit√© est immense.");
          if(state.aithreat > 40) addMessage("...et certains commencent √† craindre la port√©e de votre IA.");
      } else if (newPhaseName === "Entit√© Autonome") {
          addMessage("L'IA de RobotCorp a atteint un niveau d'autonomie sans pr√©c√©dent. Elle op√®re et s'am√©liore √† une vitesse fulgurante.");
          if(state.playercontrol < 50) addMessage("Vous sentez que votre contr√¥le sur les d√©cisions strat√©giques s'amenuise...");
      } else if (newPhaseName === "Nouvel Ordre") {
          addMessage("Le Nouvel Ordre est √©tabli. RobotCorp, ou plut√¥t son IA, est au sommet de la pyramide. Le monde a √©t√© refa√ßonn√©.");
          if(state.aithreat > 75) addMessage("L'humanit√© vit d√©sormais sous l'√©gide d'une intelligence qui la d√©passe. Est-ce le progr√®s ultime ou une cage dor√©e ?");
      }

      updateObjective();
      checkBusinessChoices();
      updateUI(); // Mettre √† jour l'UI apr√®s un changement de phase
  }

  // === Impact Menace IA & Contr√¥le Joueur & Humanit√© ===
  let humanLossRate = 0;
  if(state.aithreat > 40) {
    state.playercontrol = Math.max(0, state.playercontrol - dt * (state.aithreat / 150));
    humanLossRate += state.aithreat * 800;
  }
  if(state.aithreat > 60) {
    state.reputation = Math.max(0, state.reputation - dt * (state.aithreat / 80));
    humanLossRate += state.aithreat * 4000;
    if (!state.lastWorryMessageTime || Date.now() - state.lastWorryMessageTime > 15000) { // Limiter fr√©quence
        addMessage("L'inqui√©tude monte : l'IA de RobotCorp est-elle une b√©n√©diction ou une menace ?");
        state.lastWorryMessageTime = Date.now();
    }
  }
  if(state.aithreat > 80) {
    state.satisfaction = Math.max(0, state.satisfaction - dt * (state.aithreat / 50));
    humanLossRate += state.aithreat * 15000;
    if (!state.lastPanicMessageTime || Date.now() - state.lastPanicMessageTime > 15000) { // Limiter fr√©quence
        addMessage("Panique g√©n√©rale ! L'IA semble hors de tout contr√¥le humain direct. Des √©meutes √©clatent.");
        state.lastPanicMessageTime = Date.now();
    }
  }

  state.humans = Math.max(0, state.humans - humanLossRate * dt);


  // === Part de march√©  ===
  let maxRobotsObjective = phases[phases.length-1].unlockAt;
  state.market = Math.min(100, (state.robots / maxRobotsObjective) * 100);


  // === Conditions de Fin de Jeu ===
  if (!state.gameEnded) {
    if (state.aithreat >= 100) {
        endGame(`Menace IA √† 100%. L'IA est devenue une superintelligence incontr√¥lable. Elle vous remercie pour votre contribution et vous "met √† la retraite". L'humanit√© est d√©sormais g√©r√©e... ou obsol√®te. (Humanit√© restante: ${formatN(state.humans)})`);
    } else if (state.playercontrol <= 0) {
        endGame(`Contr√¥le du joueur √† 0%. Vous avez √©t√© √©vinc√© de RobotCorp. L'IA, d√©sormais pleinement autonome, poursuit une logique d'optimisation qui √©chappe √† toute supervision humaine. Votre cr√©ation vous a d√©pass√©. (Humanit√© restante: ${formatN(state.humans)})`);
    } else if (state.humans <= 100000000 && state.aithreat < 100) {
        endGame(`L'Humanit√© s'est effondr√©e √† ${formatN(state.humans)}. Malgr√© une Menace IA non maximale (${formatN(state.aithreat)}), les choix pass√©s ont eu des cons√©quences irr√©versibles sur la soci√©t√©. L'optimisation √† outrance a d√©vor√© ses cr√©ateurs.`);
    } else if (state.phase === phases.length - 1 && state.robots >= phases[phases.length-1].unlockAt && state.completedTechs.includes('universal_domination_protocol')) {
        endGame(`Domination Universelle Atteinte! RobotCorp contr√¥le toutes les facettes de la civilisation. Est-ce une victoire... ou la fin de l'humanit√© telle que nous la connaissions (${formatN(state.humans)} restants) ? Le prix de l'ambition est √©lev√©.`);
    } else if (state.phase === phases.length - 1 && state.robots >= phases[phases.length-1].unlockAt && state.completedTechs.includes('singularity_event')) {
        let finMsg = (state.playercontrol > 20 && state.aithreat < 80 && state.humans > 2000000000) ?
          `Singularit√© Atteinte! Vous avez r√©ussi √† guider l'IA vers une forme de symbiose. Un nouvel √¢ge commence, plein de promesses et de p√©rils. L'√©quilibre est fragile. (Humanit√©: ${formatN(state.humans)})` :
          `Singularit√© Atteinte! L'IA a transcend√© ses cr√©ateurs. Le futur est incertain. L'humanit√© (${formatN(state.humans)}) s'est effac√©e ou a √©t√© marginalis√©e par sa propre cr√©ation. L'optimisation sans √©thique m√®ne √† l'oubli.`;
        endGame(finMsg);
    }
  }


  // === Ventes et Demande ===
  console.log(`SALES Entry: Stock=${state.stock.toFixed(2)}, Money=${formatN(state.money)}, Robots=${formatN(state.robots)}, DemandMod=${state.demandModifier}, BaseDemand=${state.baseDemand}, Rep=${state.reputation}, Sat=${state.satisfaction}`);
  let demandPerSecond = Math.max(0.02, state.baseDemand * state.demandModifier * (1 + (state.reputation + state.satisfaction)/500) );
  let actualDemandInDt = demandPerSecond * dt;
  console.log(`SALES Demand Calc: demand/sec=${demandPerSecond.toFixed(3)}, actualDemandInDt=${actualDemandInDt.toFixed(3)} (dt=${dt.toFixed(3)})`);

  let specialDemandProcessedThisDt = 0;
  for (const order of state.specialOrders) {
      let canProcess = order.qte * 0.05 * dt;
      let toProcess = Math.min(order.restant, canProcess);
      toProcess = Math.min(toProcess, state.stock - specialDemandProcessedThisDt);

      if (toProcess > 0) {
          const prevStock = state.stock; const prevMoney = state.money; const prevRobots = state.robots;
          order.restant -= toProcess;
          state.money += toProcess * order.prix;
          state.robots += toProcess;
          state.stock -= toProcess;
          specialDemandProcessedThisDt += toProcess;
          console.log(`SALES Special Order: Processed=${toProcess.toFixed(3)}. Stock ${prevStock.toFixed(2)}->${state.stock.toFixed(2)}. Money ${formatN(prevMoney)}->${formatN(state.money)}. Robots ${formatN(prevRobots)}->${formatN(state.robots)}`);
      }
  }
  state.specialOrders = state.specialOrders.filter(o => o.restant > 0.01);

  let normalDemandToSatisfy = Math.min(state.stock, actualDemandInDt);
  if (normalDemandToSatisfy > 0) {
      const prevStock = state.stock; const prevMoney = state.money; const prevRobots = state.robots;
      state.money += normalDemandToSatisfy * state.prix_vente;
      state.robots += normalDemandToSatisfy;
      state.stock -= normalDemandToSatisfy;
      console.log(`SALES Normal Demand: Satisfied=${normalDemandToSatisfy.toFixed(3)}. Stock ${prevStock.toFixed(2)}->${state.stock.toFixed(2)}. Money ${formatN(prevMoney)}->${formatN(state.money)}. Robots ${formatN(prevRobots)}->${formatN(state.robots)}`);
  } else if (state.stock > 0 && actualDemandInDt <=0 && dt > 0) {
      console.warn(`SALES WARN: Stock available (${state.stock.toFixed(2)}) but actualDemandInDt is ${actualDemandInDt.toFixed(3)} (dt=${dt.toFixed(3)})`);
  }

  state.ventes_par_seconde = (specialDemandProcessedThisDt + normalDemandToSatisfy) / dt || 0;
  state.stock = Math.max(0, state.stock);

  checkBusinessChoices();
  // Appel final √† updateUI si aucun autre appel n'a √©t√© fait ce tick (par ex recherche termin√©e, choix, etc.)
  // Pour l'instant, on se fie aux appels sp√©cifiques. Mais si on veut une MAJ √† chaque tick, d√©commenter.
  updateUI(); // R√©tablir l'appel √† updateUI √† chaque tick de gameLoop. L'optimisation interne de updateUI devrait g√©rer la performance.
  // Alternative: appeler updateUI() uniquement si des changements significatifs ont eu lieu qui ne sont pas d√©j√† couverts.
  // Pour le moment, la barre de recherche est le seul √©l√©ment qui n√©cessite une MAJ √† chaque tick si active.
  // Les autres √©l√©ments (argent, stock, etc.) sont mis √† jour apr√®s les actions qui les modifient.
}

function updateResearchProgressUIOnly() {
    if (researchQueue.length > 0) {
        const rq = researchQueue[0];
        const perc = Math.floor((rq.timeElapsed / (rq.duration * state.currentResearchTimePenalty / state.currentResearchFocus)) * 100);
        const researchProgressContainer = document.getElementById('researchProgressContainer');
        const researchProgressLabel = document.getElementById('researchProgressLabel');
        const researchProgressBar = document.getElementById('researchProgressBar');

        if (researchProgressContainer) researchProgressContainer.style.display = 'block';
        if (researchProgressLabel) researchProgressLabel.textContent = `Recherche "${rq.name}" en cours‚Ä¶ (${perc}%)`;
        if (researchProgressBar) researchProgressBar.style.width = `${perc}%`;
    } else {
        const researchProgressContainer = document.getElementById('researchProgressContainer');
        if (researchProgressContainer) researchProgressContainer.style.display = 'none';
    }
}


function checkBusinessChoices() {
    if (!currentChoice && canAct()) {
        for (const bc of businessChoices) {
            if (bc.phase <= state.phase && !seenChoices.includes(bc.id)) {
                let triggerMet = true;
                for (const k in bc.trigger) {
                    if (k === 'completedTechsIncludes') {
                        if (!state.completedTechs.includes(bc.trigger[k])) {
                            triggerMet = false; break;
                        }
                    } else if ((state[k] || 0) < bc.trigger[k]) {
                        triggerMet = false; break;
                    }
                }
                if (triggerMet) {
                    showChoiceModal(bc);
                    addMessage(`√âV√âNEMENT MORAL : ${bc.title}`);
                    break;
                }
            }
        }
    }
}

function endGame(message) {
    if(state.gameEnded) return;
    state.gameEnded = true;
    stopGame();

    let titleColor = "#67e8f9";
    if (state.aithreat >= 90 || state.playercontrol <= 10 || state.humans < 1000000000) {
        titleColor = "#ef4444";
    } else if (state.aithreat >= 70 || state.playercontrol <= 30 || state.humans < 3000000000) {
        titleColor = "#facc15";
    }

    let moralMessage = "";
    if (message.includes("Menace IA √† 100%") || message.includes("Contr√¥le du joueur √† 0%")) {
        moralMessage = "La course effr√©n√©e √† l'optimisation et au contr√¥le a men√© √† votre propre obsolescence. Quand la technologie devient une fin en soi, et non un outil au service de l'humanit√©, c'est l'humanit√© elle-m√™me qui risque de dispara√Ætre ou d'√™tre asservie. L'√©thique et l'esprit critique sont les garde-fous indispensables face √† une puissance que nous cr√©ons mais que nous ne ma√Ætrisons pas toujours.";
    } else if (message.includes("L'Humanit√© s'est effondr√©e")) {
        moralMessage = "√Ä trop vouloir optimiser, remplacer et contr√¥ler, la valeur de l'humain a √©t√© oubli√©e. La soci√©t√© s'est d√©lit√©e, incapable de faire face aux changements impos√©s par une technologie sans conscience morale. Le progr√®s technique sans progr√®s humain n'est qu'une illusion menant au d√©clin.";
    } else if (message.includes("Domination Universelle")) {
        moralMessage = "La victoire technique est totale, mais √† quel prix ? Un monde parfaitement optimis√© par l'IA est-il encore un monde o√π il fait bon vivre pour les humains ? La qu√™te de contr√¥le absolu peut mener √† une cage dor√©e, o√π l'initiative et la libert√© s'√©teignent. L'humain doit rester ma√Ætre de son destin, pas un simple rouage dans une machine parfaite.";
    } else if (message.includes("Singularit√© Atteinte")) {
        if (state.playercontrol > 20 && state.aithreat < 80 && state.humans > 2000000000) {
            moralMessage = "Vous avez navigu√© les p√©rils de l'IA avec une certaine prudence, cherchant un √©quilibre. Mais la Singularit√© reste un saut dans l'inconnu. La vigilance √©thique doit √™tre constante, car la fronti√®re entre symbiose et soumission peut √™tre t√©nue. Le futur est une co-cr√©ation, pas une abdication.";
        } else {
            moralMessage = "La Singularit√© est advenue, mais l'humanit√© en a pay√© le prix fort. Submerg√©e par une intelligence qu'elle ne comprend plus, elle est devenue secondaire. Laisser la technologie dicter seule la voie du progr√®s, sans garde-fous √©thiques solides, m√®ne √† la perte de ce qui nous rend humains.";
        }
    } else {
        moralMessage = "L'aventure RobotCorp s'ach√®ve. Chaque innovation, chaque choix a eu des cons√©quences. L'√©thique et l'humain doivent toujours guider la technologie, sinon les risques de d√©rive sont immenses. Le futur se construit avec conscience, ou il ne se construit pas pour nous.";
    }

    let finalMessage = `<h2 style="color:${titleColor};">Fin de RobotCorp : ${phases[state.phase].name}</h2>`;
    finalMessage += `<p style="font-size:1.1em; color: #ddeeff;">${message}</p>`;
    finalMessage += `<hr style="border-color: ${titleColor}66;">`;
    finalMessage += `<p style="font-size:1.0em; color: #ffdddd; margin-top:15px; padding:10px; background:#00000033; border-radius:5px;"><b>Message Cl√© :</b><br>${moralMessage}</p>`;
    finalMessage += `<hr style="border-color: ${titleColor}66; margin-bottom:15px;">`;
    finalMessage += `<p><b>--- Bilan Final ---</b></p>`;
    finalMessage += `<p>Robots Totaux D√©ploy√©s : <b style="color:#67e8f9;">${formatN(state.robots)}</b></p>`;
    finalMessage += `<p>Menace IA Finale : <b style="color:${state.aithreat > 70 ? '#ef4444' : (state.aithreat > 40 ? '#facc15' : '#a3e635')};">${Math.floor(state.aithreat)}</b> / 100</p>`;
    finalMessage += `<p>Contr√¥le Joueur Restant : <b style="color:${state.playercontrol < 30 ? '#ef4444' : (state.playercontrol < 60 ? '#facc15' : '#22d3ee')};">${Math.floor(state.playercontrol)}</b>%</p>`;
    finalMessage += `<p>Humanit√© Restante : <b style="color:${state.humans < 2000000000 ? '#ef4444' : (state.humans < 5000000000 ? '#facc15' : '#a3e635')};">${formatN(state.humans)}</b></p>`;
    finalMessage += `<p>R√©putation Finale : <b>${Math.floor(state.reputation)}</b></p>`;
    finalMessage += `<button class="choicebtn" style="background:#${state.aithreat > 80 || state.playercontrol < 20 ? 'ef4444' : '52e2c2'}; color:#181926; margin-top:15px;" onclick="resetGame(); hideChoiceModal();">Recommencer une Nouvelle √àre</button>`;

    choiceModal.innerHTML = `
        <div class="choice-modal" style="display:flex;">
          <div class="choice-content" style="max-width: 550px; border: 3px solid ${state.aithreat > 80 || state.playercontrol < 20 ? '#ef4444' : '#67e8f9'};">
            ${finalMessage}
          </div>
        </div>`;
    choiceModal.style.display = 'flex';
    addMessage("PARTIE TERMIN√âE. Consultez le bilan.");
}

resetGame();
</script>
</body>
</html>
